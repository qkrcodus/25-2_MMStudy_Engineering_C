## 알림 시스템 설계

하루에 백만건 이사의 알림을 처리하는 확장성 높은 시스템을 구축하는게 목표 

- 푸시 알림, SMS 메시지, 이메일
- 실시간 시스템
- 알림은 클라이언트 애플리케이션 프로그램 또는 서버 측에서 스케줄링 할 수도 있음
- 사용자는 알림 기능을 끌 수 있음

### 1. ios, 안드로이드 푸시 알림

3가지 컴포넌트가 필요하다 ( 알림 제공자, APNS, ios 단말 )

알림 요청을 알림 제공자가 만들어 애플 푸시 알림 서비스에게 보낸다. 

알림 요청을 만들기 위해 필요한 데이터는 다음과 같다.

- 단말 토큰 : 알림 요청을 보내는 고유 식별자
- 페이로드 : 알림 내용을 담은 JSON 딕셔너리
    <img width="680" height="259" alt="스크린샷 2025-08-27 오후 6 30 43" src="https://github.com/user-attachments/assets/e523c077-bd12-4e54-aa93-b762aac32fcb" />

애플이 제공하는 원격 서비스인 APNS는 푸시 알림을 ios 장치로 보낸다. 

안드로이드는 APNS 대신 FCM을 사용한다. 

### 2. SMS 메시지와 이메일

SMS 메시지는 트윌리오, 넥스모와 같은 제 3 사업자의 서비스를 많이 사용하며 이용 요금을 내야한다.

이메일은 상용 이메일 서비스인 센드그릳, 메일침프을 많이 사용한다. 전송 성공률도 높고 데이터 분석 서비스도 제공한다. 

### 연락처 정보 수집 절차

필요한 정보 

- 모바일 단말 토큰
- 전화번호
- 이메일 주소

사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하면, API 서버는 해당 사용자의 정보를 수집하여 DB에 저장한다. 

( 로그인 → 사용자 gmail 계정이 DB에 저장된다 )

<img width="703" height="196" alt="스크린샷 2025-08-27 오후 6 31 24" src="https://github.com/user-attachments/assets/ebe9059f-6207-419d-8ee6-5967174d0593" />

( device 테이블을 새롭게 생성하여, user 테이블과 일대다 관계를 맺는다 )

<img width="703" height="291" alt="스크린샷 2025-08-27 오후 6 31 32" src="https://github.com/user-attachments/assets/5d1ecf21-474d-4bcd-addb-9b2bb178bf50" />

### 알림 시스템 설계 초안

- 알림 서버가 한 개뿐이라 서버에 장애가 생기면 전체 서비스 장애로 이어진다.
- 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
- 알림을 처리하고 보내는 것을 한 서버로 처리하면 사용자 트래픽이 몰리는 시간에 시스템이 과부하 상태에 빠질 수 있다.

<img width="696" height="512" alt="스크린샷 2025-08-27 오후 6 31 40" src="https://github.com/user-attachments/assets/07f91355-8563-4886-a4ae-5918559496c7" />

### 알림 시스템 개선된 버전

- 데이터베이스와 캐시를 알림 시스템 주 서버에서 분리한다
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이뤄질 수 있도록 한다
- 메시지 큐를 사용해 시스템 컴포넌트 사이 결합을 끊는다
  
<img width="702" height="452" alt="스크린샷 2025-08-27 오후 6 31 47" src="https://github.com/user-attachments/assets/f59b5b2f-b59c-4034-bb2a-38ad960b9e97" />

### 1~N 까지의 서비스

- 서비스는 각각 마이크로 서비스, 크론잡, 분산 시스템 컴포넌트일 수 있다.

### 알림 서버

- 인증된 클라이언트만 이용가능한 알림 전송 API 제공
- 알림 검증 ( 이메일 주소, 전화번호 등에 대한 기본적 검증 )
- 알림에 포함할 데이터 가져오기 위한 데이터베이스나 캐스 질의
- 알림 데이터를 메시지 큐에 넣음
  
<img width="699" height="448" alt="스크린샷 2025-08-27 오후 6 31 55" src="https://github.com/user-attachments/assets/4468c7db-ab4c-4657-9030-587852414f14" />

### 메시지큐

- 시스템 컴포넌트간 의존성을 제거
- 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할

### 작업 서버

- 메시지 큐에서 전송할 알림을 꺼내 제 3자 서비스로 전달

### 흐름

1. 사용자는 앱을 다운 받고 알림 받기 기능을 허용한다.
2. 앱이 OS 로부터 단말 토큰을 받아온다.
3. 사용자가 로그인을 한다.
4. 사용자 ID와 단말토큰을 서버로 보내고 이 값을 DB에 저장한다.
5. API 호출하여 알림 서버로 알림을 보낸다. 
6. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타 데이터를 캐시나 DB에서 가져온다.
7. 알림 서버는 이벤트를 만들어 큐에 넣는다. 
8. 작업 서버는 메시지 큐에서 알림 이벤트를 꺼내고 제 3자 서비스로 보낸다.
9. 제 3자 서비스는 사용자 단말로 알림을 전송한다. 

### 안정성을 확보하기 위한 고려 사항

1. 데이터 손실 방지를 위해 알림 로그 데이터베이스를 유지

<img width="675" height="353" alt="스크린샷 2025-08-27 오후 6 32 01" src="https://github.com/user-attachments/assets/97414c62-9197-44c9-b196-242b034c8418" />
 
4. 이미 한번 보낸 알림 이벤트 ID를 검사하여, 중복된 이벤트인지 확인하여 데이터 중복을 방지한다.

### 추가 컴포넌트

- 알림 템플릿
- 유저별 알림 설정 여부
- 유저 알림 빈도 제한
- 인증된 클라이언트만 알림 API를 보낼 수 있게 하기
- 큐에 쌓인 알림 개수 모니터링
- 이벤트 추적
    
<img width="672" height="393" alt="스크린샷 2025-08-27 오후 6 32 11" src="https://github.com/user-attachments/assets/7efb6afa-df13-4f4a-b6d2-e76005666a42" />

### 정리 - 알림 시스템을 구현하고 싶다 [ 초기 단계  ]

규모가 작은 사이드 프로젝트에선 당장 필요하지 않은 분산 처리, 메시지 큐 등은 도입하지 않고 서버 비용을 최소화하는게 더 좋아 보인다. 

### 기술 스택 및 아키텍처

- 알림 인프라: Firebase Cloud Messaging (FCM)

iOS/Android 플랫폼 지원, 무료라는 장점

- 아키텍처: 알림 서버와 작업 서버를 따로 두지 않고 기존 애플리케이션 서버가 비즈니스 로직 처리와 알림 발송 요청을 모두 담당한다.

### 클라이언트

1. Firebase SDK 설정 : 각 OS(iOS, Android) 가이드에 따라 Firebase SDK를 프로젝트에 설정하고 초기화
2. 사용자가 알림을 허용하면 firebase SDK를 통해 단말기의 토큰을 받아온다.
3. 유저가 로그인하면 user_id와함께 단말기의 토큰을 서버에게 보낸다. 
4. 이벤트 리스너를 통해 알림을 받게 되면 팝업을 띄우는 기능을 구현한다. 

### 서버

1. firebase admin SDK를 설정하고 device 테이블을 추가한다. ( 한 유저는 아이폰, 아이패드 등 여러 기기로 로그인할 수 있기게 유저-디바이스 는 일대다 관계로 설정한다 ) 
2. 클라이언트로부터 user_id와 단말기 토큰을 데이터 베이스에 저장하고 로그아웃시 토큰을 삭제하는 api 를 구현한다.
3. 알림 발송 로직을 별도의 service 클래스를 만들고 구현한다. 
4. 알림 요청이 들어오면 알림을 받을 `user_id`를 기반으로 `devices` 테이블에서 모든 활성 `device_token` 목록을 조회한다. 
5. firebase admin SDK를 사용해서 메시지를 구성하고 조회된 토큰을 타깃으로 FCM에 메시지 발송을 요청한다.

하지만 이 방식은 책에서 언급한 것처럼 서버에 작업, 알림 기능이 함께 있어 문제가 생긴다면 서비스 전체에 장애가 생길 수 있으며 트래픽이 몰릴 경우 과부화에 빠질 위험이 있으며 알림만을 위한 전용 데이터 베이스나 캐시의 독립적 증설이 어렵다는 단점이 있다. 

### 알림 시스템을 구현하고 싶다 [ 규모가 커질 경우 ]

<img width="628" height="805" alt="스크린샷 2025-08-27 오후 6 32 26" src="https://github.com/user-attachments/assets/e764a318-a5ef-4b4b-9e6d-c784de1203f3" />

규모가 커져 주문-배송 처리 서비스, 음식 추천 서비스, 쿠폰 알림 서비스등 여러 이벤트 발행자가 있는 상황을 가정해보자. 

각 서비스는 본인의 비즈니스 로직을 처리하다가 알림이 필요한 이벤트가 발생하면, 해당 사실을 알림 서버에게 알린다. 알림 서버는 요청을 보낸 서비스가 정상적인지 인증하고, 캐시와 데이터베이스를 조회하여 알림 발송에 필요한 단말 토큰 , 알림 허용 정보등을 가져와 메시지를 완성한다.

완성된 메시지는 메시지 큐에 저장하고 작업 서버는 알림 템플릿을 통해 메시지 문구를 완성하고 FCM ( 이나 APNs) 에 알림 발송을 요청하고 발송 결과를 알림 로그에 기록한다. 

---
