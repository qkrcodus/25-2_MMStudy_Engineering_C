- 알림 시스템의 3가지 종류
  - 모바일 푸시 알림
  - SMS 메시지
  - 이메일

## 1. 문제 이해 및 설계 범위 확정
- 어떤 종류의 알림을 지원하는지
- 실시간 시스템인지
- 어떤 종류의 단말을 지원해야 하는지
- 사용자에게 보낼 알림은 누가 만들 수 있는지
- 사용자가 알림을 받지 않도록(opt-out) 설정할 수 있는지
- 하루에 몇 건의 알림을 보낼 수 있어야 하는지

## 2. 개략적 설계안 제시 및 동의 구하기
- 알림 유형별 지원 방안
  - iOS 푸시 알림
    - 알림 제공자: 알림 요청을 만들어 APNS(Apple Push Notification Service)로 보내는 주체
    - 단말 토큰: 알림 요청을 보내는 데 필요한 고유 식별자
    - 페이로드(payload): 알림 내용을 담은 JSON 딕셔너리
    - APNS: 푸시 알림을 iOS 장치로 보내는 역할의 애플이 제공하는 원격 서비스
    - iOS 단말: 푸시 알림을 수신하는 사용자 단말
  - 안드로이드 푸시 알림
    - iOS 푸시 알림과 비슷하나 APNS 대신 FCM(Firebase Cloud Messaging)을 사용
  - SMS 메세지
    - Twilio, Nexmo 같은 제 3 사업자의 서비스 이용
  - 이메일
    - Sendgrid, Mailchimp 같은 상용 이메일 서비스 이용
- 연락처 정보 수집 절차
  - 사용자가 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장
  - 이때 이메일 주소와 전화번호는 user 테이블에 저장하고, 단말 토큰은 device 테이블에 저장(한 사용자가 여러 단말을 가질 수 있기 때문)
- 알림 전송 및 수신 절차(초안)
  - 1 - N 서비스
  - 알림 시스템: 1개 서버만 사용한다고 가정, 알림 전송 API를 제공하고, 제 3자 서비스에 전달할 알림 페이로드를 만들어 내야 한다
  - 제 3자 서비스
    - 확장성: 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야 함
    - 어떤 서비스는 다른 시장에서 사용할 수 없음(ex: FCM을 중국에서 사용할 수 없음)
- 초안의 문제점
  - SPOF: 서버 하나의 장애가 전체 서비스의 장애로 이어진다
  - 규모 확장성: 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트 규모를 개별적으로 늘릴 방법이 없다
  - 성능 병목: 사용자 트래픽이 많이 몰리면 시스템 과부하 상태에 빠질 수 있다
- 개선된 버전
  - 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리
   - 알림 서버를 증설하고 자동적으로 수평적 규모 확장이 이루어질 수 있도록
   - 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다
   - 알림 서버에서 제공하는 기능들
     - 알림 전송 API
     - 알림 검증
     - 데이터베이스 또는 캐시 질의
     - 알림 전송
   - 작업 서버: 메시지 큐에서 전송할 알림을 꺼내서 제3자 서비스로 전달하는 역할을 담당하는 서버

<img width="582" height="390" alt="image" src="https://github.com/user-attachments/assets/0ad2cd95-8020-4577-842b-89d3a33dcbac" />
   
## 3. 상세 설계
- 안정성
  - 어떤 상황에서도 알림이 소실되면 안 된다: 알림 로그 데이터베이스 유지
  - 알림 중복 전송 방지: 중복 탐지 로직 사용(이벤트 ID 검사)
- 알림 템플릿
  - 파라미터, 스타일, 추적 링크만 조정하면 사전 지정 형식에 맞춰 알람을 만들 수 있다
- 알림 설정
  - 테이블에 해당 채널로 알림을 받을 것인지 여부 필요
  - 사용자가 해당 알림을 켜 두었는지 알림을 보내기 전에 확인해야 함
- 전송률 제한: 한 사용자가 받을 수 있는 알림의 빈도 제한
- 재시도 방법: 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다
- 푸시 알림과 보안: iOS와 안드로이드의 경우, 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지
- 큐 모니터링: 큐에 쌓인 알림의 개수는 알림 시스템을 모니터링할 때 중요한 메트릭. 이 수가 너무 크면 작업 서버를 증설하는게 바람직
- 이벤트 추적: 알림 확인율, 클릭율 등 메트릭은 사용자를 이해하는데 중요. 데이터 분석 서비스는 보통 이벤트 추적 기능 제공

## 4. 마무리
- 안정성: 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘 도입
- 보안: 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 메커니즘 이용
- 이벤트 추적 및 모니터링: 알림이 만들어진 후 성공적으로 전송되기까지의 과정 추적, 시스템 상태 모니터링하기 위해 알림 전송의 각 단계마다 이벤트 추적, 모티터링할 수 있는 시스템 통합
- 사용자 설정: 사용자가 알림 수신 설정을 조정할 수 있도록 하였다
